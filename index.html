<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="LeBron_Six 的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="LeBron_Six 的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LeBron_Six 的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>LeBron_Six 的博客</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?eda0d89c61ce94284ad4c17fdc3d79c7";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LeBron_Six 的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/11/android-10-technique/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LeBron_Six">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/15133565?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LeBron_Six 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/11/android-10-technique/" itemprop="url">10 个你有可能不知道的Android Studio技巧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-11T21:13:04+08:00">
                2016-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>英文原文：<a href="https://medium.com/google-developers/about-10-things-you-probably-didn-t-know-you-could-do-in-android-studio-de231071b375#.9wc67rigb" target="_blank" rel="external">medium</a></p>
<p>[TOC]</p>
<p><code>Android Studio</code> 是每一个 Android 开发每天都要使用的工具，但是即使你是一个经验丰富的开发人员，你也可能已经错过了许多可以节约生命的技巧，这篇文章也许就可以帮助你掌握它们其中的一部分。我不会一字一句地翻译，而是以最简洁易懂的方式介绍给你，同时提供必要的注解和延伸，让你可以在一遍快速阅读之后迅速掌握。</p>
<h2 id="当你想不起来某个功能怎么用的时候"><a href="#当你想不起来某个功能怎么用的时候" class="headerlink" title="当你想不起来某个功能怎么用的时候"></a>当你想不起来某个功能怎么用的时候</h2><p>如果你是 Windows/Linux 用户, 那么请按<code>Ctrl + Shift + A</code>， 如果你是 Mac 用户，那么请按<code>Command + Shift + A</code>，在这个万能的输入框内可以输入你想要执行的操作（当然是英文），列表中会显示对应的可选操作以及快捷键。不仅仅是操作，如果你只是想改变某个设置的时候，也可以使用这个功能，例如你想设置Gradle为 offline work 的话，可以在输入框输入offline，对应的的结果中选择Toggle Offline Work即可，再比如你需要打开粘贴代码时候的Auto Import功能，那么也只要在输入框中输入<code>Auto Import</code>然后选择对应项即可。</p>
<p><img src="http://img.my.csdn.net/uploads/201610/11/1476156495_4652.gif" alt="这里写图片描述"></p>
<h2 id="修改快捷键"><a href="#修改快捷键" class="headerlink" title="修改快捷键"></a>修改快捷键</h2><p>在 Android Studio 中所有快捷键都是可以自定义的。请唤起伟大的<code>Ctrl + Shift + A</code>，输入keymap，选择位于<code>Settings &gt; Keymap</code>的那个选项，这里能看到所有的快键键，一般不建议在原有快捷键方案上直接修改快捷键，而是拷贝一份现有的方案再在上面改，在Keymaps的下拉框中选择一份现有的方案（默认为 Default），点击右边的Copy，然后在列表中需要修改的快捷键的项目上右键，选择<code>Add Keyboard Shortcut</code>，然后就可以设置自己喜欢的快捷键了，如果设置的快捷键与其它按键有冲突，会以红色错误信息提示。</p>
<p><img src="http://img.my.csdn.net/uploads/201610/11/1476156633_8287.gif" alt="这里写图片描述"></p>
<p>由于列表中快捷键数量比较多，所以我们还可以利用右边的搜索框进行搜索，例如需要修改基本自动补全的快捷键我们只要输入<code>Basic</code>，就可以在结果中找到对应的项了。</p>
<h2 id="你需要了解的自动补全"><a href="#你需要了解的自动补全" class="headerlink" title="你需要了解的自动补全"></a>你需要了解的自动补全</h2><p>一般使用 Android Studio 的时候，自动提示会在你想要提示的时候自动出现，比如输入Log.，就会提示一堆比如<code>Log.d(), Log.e, Log.i()</code>。不过如果你在自动提示的时候手一抖选错的话，比如想选Log.d()结果选了Log.e()，你是不是会把.e()都删掉，然后再输入一个.，其实遇到这种需要重新手动呼起自动补全的情形只需要使用<code>Ctrl + Alt + 空格</code>就可以了。</p>
<p><img src="http://img.blog.csdn.net/20161011114407507" alt="这里写图片描述"></p>
<p>其实还有两种方法：一是基本补全<code>Ctrl + 空格</code>，然而 Windows 用户表示不开心，因为这和 Windwos 系统切换输入法快捷键冲突，如果你不想修改这个快捷键，那么使用<code>Ctrl + Alt + 空格</code>作为替代，如果你想修改这个快键键，那么你可以使用上一小节的方法设置新的快捷键，在Keymaps界面搜索Basic，然后在过滤后的结果中选择<code>Code-&gt;Completion-&gt;Basic</code>进行设置；另一种方法是智能补全<code>Ctrl + Shift + 空格</code>, 不过智能补全远远不止这个功能，当你调用方法时，可以使用智能补全在当前上下文联想符合该方法形参类型的变量。</p>
<h2 id="在自动提示以后使用-Tab-键替换当前的方法或值"><a href="#在自动提示以后使用-Tab-键替换当前的方法或值" class="headerlink" title="在自动提示以后使用 Tab 键替换当前的方法或值"></a>在自动提示以后使用 Tab 键替换当前的方法或值</h2><p>如果我们手动呼出自动补全的时候，当前位置已经有对应的方法或者变量（比如原来调用Obj的A方法，然后我们把光标定位到A方法的位置，呼出自动补全，希望自动补全的B方法代替A方法），这时候如果我们选中补全的的项目，按下回车，那么补全的内容会插入到原来内容的前面，这不是我们想要的内容，其实这时候不应该按回车，而是Tab。</p>
<p><img src="http://img.blog.csdn.net/20161011114513587" alt="这里写图片描述"></p>
<h2 id="当你写完了一行代码"><a href="#当你写完了一行代码" class="headerlink" title="当你写完了一行代码"></a>当你写完了一行代码</h2><p>这种情况非常常见，当你写完一行代码的时候，光标并不在当前行的末尾，比较常见的是光标右边还有 N 个 右括号，这时候你会怎么办？可能你会使用方向键把光标移动到行末，然后手动输入一个;。其实有更简单的方案，那就是<code>Ctrl + Shift + 回车</code>，这个快捷键会帮助你自动补全当前表达式所缺的部分，包括在行末输入;，值得一提的是，该快捷键对if，else，for，while控制循环同样有效。</p>
<p><img src="http://img.blog.csdn.net/20161011114552592" alt="这里写图片描述"></p>
<p>还有一种情况，光标并不在行尾，但是你希望可以在下一行插入一个空行，Shift + 回车可以帮你完成这个任务。</p>
<h2 id="三个定位的小技巧"><a href="#三个定位的小技巧" class="headerlink" title="三个定位的小技巧"></a>三个定位的小技巧</h2><p>使用 4 个方向键定位光标是我们最熟悉的方法，但是其实可以更方便的。在按方向键的同时按住Ctrl，可以一个单词一个单词移动；在按上下键的同时按住Alt, 可以一个节点（方法或者字段）一个节点移动；如果在按上下键的同时按住<code>Shift + Ctrl</code>，可以把当前行和上下行交换位置。</p>
<h2 id="根据后缀自动生成的代码模板"><a href="#根据后缀自动生成的代码模板" class="headerlink" title="根据后缀自动生成的代码模板"></a>根据后缀自动生成的代码模板</h2><p>日常使用编辑器的过程中，有很多固定格式的写法，例如if-else, for 等等，使用代码模板可以更快得帮助我们生成期望的代码。举个例子，先输入一个集合类型的变量并且加上后缀.fori，这时候自动提示会提示按照该集合类型生成for循环，同理，布尔类型的表达式加上.if后缀也可以生成以该表达式为条件的if语句。</p>
<p><img src="http://img.my.csdn.net/uploads/201610/11/1476156977_4184.gif" alt="这里写图片描述"></p>
<p>实际上，上面这两种代码模板是IntelliJ自带的，Android Studio 还提供了许多与 Android 有关的代码模板，比如生成Toast和Parcelable的模板，查看所有可用模板以及自定义模板的方法是首先<code>Ctrl + Shift + A</code>呼出万能的搜索框，输入<code>Live templates</code>，选择位于Settings的Live Templates，在这里就可以看到所有可用的代码模板。</p>
<h2 id="Debug-时自定义对象显示的技巧"><a href="#Debug-时自定义对象显示的技巧" class="headerlink" title="Debug 时自定义对象显示的技巧"></a>Debug 时自定义对象显示的技巧</h2><p>在调试代码的时候，我们常常需要查看一个对象的值。尤其是自定义的对象，我们常常没有实现它的toString方法，那么这个对象在 IDE 的值就是 ClassName:HashValue 这个样子。我们需要点开这个对象查看它里面各个成员的值。在不实现toString方法的情况下其实有更好的方法。在 Debug 的Variable窗口中右键需要查看的对象，选择<code>View as</code>，既可以设置该对象在 Debug 状态下显示的方式。</p>
<p><img src="http://prototypez.github.io/images/1-D6xJW1DalD9K8miVemhmAg.gif" alt="这里写图片描述"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>感谢你看到这里</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/09/10/android-asynctask-source/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LeBron_Six">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/15133565?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LeBron_Six 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/10/android-asynctask-source/" itemprop="url">从源码角度分析AsyncTask的用法与原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-10T21:13:04+08:00">
                2016-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<p>AsyncTask 是Android特有的一个轻量级异步抽象类，在类中通过<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## 前言</div><div class="line">众所周知，Android视图的绘制、监听、事件等都UI线程（主线程，Main Thread）执行，如果执行访问网络请求、数据库等耗时操作，可能会阻塞主线程，若阻塞时间超过5秒，可能会引起系统的ANR异常（Application Not Responding）。所以耗时操作需要放在子线程（也称为Worker Thread）执行，这样就避免了主线程的阻塞，然而在线程是不能有更新UI的操作的，比如在子线程调用```TextView.setText()```就会引发以下错误：</div></pre></td></tr></table></figure></p>
<p>Only the original thread that created a view hierarchy can touch its views.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">故而可以用 “Handle + Thread”的方式，子线程执行耗时操作，通过Handler通知主线程更新UI。但是这个方式略微麻烦，于是便引入了AsyncTask。</div><div class="line"></div><div class="line">## AsyncTask特点</div><div class="line">AsyncTask&lt;Params, Progress, Result&gt; 定义了三种泛型，作用如下：</div><div class="line"></div><div class="line">- Params：启动AsyncTask任务所需要的参数，在```doInBackground```方法接收</div><div class="line">- Progress：后台任务执行进度</div><div class="line">- Result：后台任务执行完毕之后回馈给```onPostExecute```的结果</div><div class="line"></div><div class="line">AsyncTask 内部提供了多个方法，子类可重写，会自动在相应的时刻自动调用，并且用户最好不好手动调用以下的方法，避免引起不可预知的错误。以下方法只有```doInBackground```方法是必须重写的，其他方法可选。</div><div class="line"></div><div class="line">- **onPreExecute()**：任务执行之前调用</div><div class="line">- **doInBackground(Params... params)**：子线程执行任务，在这个方法中是不可以进行UI更新操作的，如果需要更新UI元素，例如展示该任务的执行进度，可以调用publishProgress(Progress... progress)方法来完成。</div><div class="line">- **onProgressUpdate(Progress... values)**：任务执行进度。可用于进度条显示</div><div class="line">- **onPostExecute(Result result)**：任务执行完毕</div><div class="line">- **onCancelled(Result reslut)**、**onCancelled()**：用户取消任务</div><div class="line"></div><div class="line">最后，调用```execute()```开启异步任务。</div><div class="line"></div><div class="line">## AsyncTask简单使用</div><div class="line">```java</div><div class="line">public void request() &#123;</div><div class="line"></div><div class="line">    AsyncTask&lt;String, Integer, Integer&gt; task = new AsyncTask&lt;String, Integer, Integer&gt;() &#123;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        protected void onPreExecute() &#123;</div><div class="line">            super.onPreExecute();</div><div class="line">            Log.i(&quot;AsyncTask&quot;, &quot;准备执行后台任务&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        protected Integer doInBackground(String... params) &#123;</div><div class="line">            String url_1 = params[0];</div><div class="line"></div><div class="line">            doRequest(url_1);</div><div class="line"></div><div class="line">            publishProgress(50);</div><div class="line"></div><div class="line">            String url_2 = params[1];</div><div class="line"></div><div class="line">            doRequest(url_2);</div><div class="line"></div><div class="line">            publishProgress(100);</div><div class="line"></div><div class="line">            return 1;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        protected void onProgressUpdate(Integer... values) &#123;</div><div class="line">            super.onProgressUpdate(values);</div><div class="line">            Log.i(&quot;AsyncTask&quot;, &quot;当前进度&quot; + values[0] + &quot;%&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        protected void onPostExecute(Integer ret) &#123;</div><div class="line">            super.onPostExecute(ret);</div><div class="line">            Log.i(&quot;AsyncTask&quot;, &quot;执行完毕，执行结果&quot; + ret);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    String url_1 = &quot;https://api.github.com/users/smuyyh&quot;;</div><div class="line">    String url_2 = &quot;https://api.github.com/users/smuyyh/followers&quot;;</div><div class="line"></div><div class="line">    task.execute(url_1, url_2); // 开启后台任务</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码较为简单，就不做过多的解释了。后面着重介绍AsyncTask的内部实现机制。</p>
<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p>这一节将从源码的角度来分析一下<a href="http://grepcode.com/file/repository.grepcode.com/java/ext/com.google.android/android/5.1.1_r1/android/os/AsyncTask.java" target="_blank" rel="external">AsyncTask</a>。以下源码基于Android-23.</p>
<ul>
<li>开启后台任务之前，首先需要创建AsyncTask的实例，所以还得从构造函数说起。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">            Result result = doInBackground(mParams);</div><div class="line">            Binder.flushPendingCommands();</div><div class="line">            <span class="keyword">return</span> postResult(result); <span class="comment">// 任务的具体实现</span></div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                postResultIfNotInvoked(get());</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                android.util.Log.w(LOG_TAG, e);</div><div class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occurred while executing doInBackground()"</span>,</div><div class="line">                        e.getCause());</div><div class="line">            &#125; <span class="keyword">catch</span> (CancellationException e) &#123;</div><div class="line">                postResultIfNotInvoked(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在构造函数中，初始化了两个变量，分别是mWorker与mFuture，mFuture创建的时候传入了mWorker参数，而mWorker本身是一个<a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/7u40-b43/java/util/concurrent/Callable.java#Callable" target="_blank" rel="external">Callable</a>对象。那么，mFutrue是个什么东西呢？</p>
<p>mFuture是一个<a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/7u40-b43/java/util/concurrent/FutureTask.java#FutureTask" target="_blank" rel="external">FutureTask</a>对象，FutureTask实际上是一个任务的操作类，它并不启动新线程，并且只负责任务调度。任务的具体实现是构造FutureTask时提供的，实现自Callable<v>接口，也就是刚才的mWorker。</v></p>
<ul>
<li>AsyncTask对象穿件完毕之后调用<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">```java</div><div class="line">@MainThread</div><div class="line">public final AsyncTask&lt;Params, Progress, Result&gt; execute(Params... params) &#123;</div><div class="line">    return executeOnExecutor(sDefaultExecutor, params);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li>
</ul>
<p>只有一句话，可知是调用executeOnExecutor进行执行。这里就有个疑问了，sDefaultExecutor是个什么东西？在说这个之前，需要明确一下一下三个事：</p>
<p><strong>1</strong>、Android3.0之前部分代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = <span class="number">5</span>;  </div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_POOL_SIZE = <span class="number">128</span>;  </div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEEP_ALIVE = <span class="number">10</span>;  </div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadPoolExecutor sExecutor = <span class="keyword">new</span> ThreadPoolExecutor(CORE_POOL_SIZE,  MAXIMUM_POOL_SIZE, KEEP_ALIVE,</div><div class="line">                TimeUnit.SECONDS, sWorkQueue, sThreadFactory);</div></pre></td></tr></table></figure></p>
<p><strong>2</strong>、在Android3.0之前，AsyncTask执行中最终触发的是把任务交给线池THREAD_POOL_EXECUTOR来执行，提交的任务并行的在线程池中运行，但这些规则在3.0之后发生了变化，3.0之后提交的任务是默认串行运行的，执行完一个任务才执行下一个！</p>
<p><strong>3</strong>、在Android3.0以前线程池里核心线程有5个，任务队列的任务数最大不能超过128个，线程池里的线程都是并行运行的，在3.0以后，直接调用execute(params)触发的是sDefaultExecutor的execute(runnable)方法，而不是原来的THREAD_POOL_EXECUTOR。在Android4.4以后，线程池大小等于 cpu核心数 + 1，最大值为cpu核心数 * 2 + 1。这些变化大家可以自行对比一下。</p>
<p>跟进源码不难发现，sDefaultExecutor实际上是指向SerialExecutor的一个实例，从名字上看是一个顺序执行的executor，并且它在AsyncTask中是以常量的形式存在的，因此在整个应用程序中的所有AsyncTask实例都会共用同一个SerialExecutor。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</div><div class="line">    Runnable mActive;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</div><div class="line">        mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    r.run();</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    scheduleNext();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</div><div class="line">            scheduleNext();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</div><div class="line">            THREAD_POOL_EXECUTOR.execute(mActive);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>SerialExecutor是使用ArrayDeque这个队列来管理Runnable对象的。当Executor提交一个任务，执行一次<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">当AsyncTask不断提交任务时，那么此时mActive不为空了，所以后续添加的任务能得到执行的唯一条件，就是前一个任务执行完毕，也就是```r.run()```。所以这就保证了SerialExecutor的顺序执行。这个地方其实也是一个坑，初学者很容易在这里踩坑，同时提交多个任务，却无法同步执行。</div><div class="line"></div><div class="line">如果想让其并行执行怎么办？AsyncTask提供了一下两种方式：</div><div class="line">```java</div><div class="line">task.setDefaultExecutor(AsyncTask.THREAD_POOL_EXECUTOR); </div><div class="line"></div><div class="line">task.executeOnExecutor(executor, params); //可以自己指定线程池</div></pre></td></tr></table></figure></p>
<ul>
<li>继续跟进<figure class="highlight plain"><figcaption><span>exec, Params... params)```代码</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">```java</div><div class="line">@MainThread</div><div class="line">public final AsyncTask&lt;Params, Progress, Result&gt; executeOnExecutor(Executor exec,</div><div class="line">        Params... params) &#123;</div><div class="line">    if (mStatus != Status.PENDING) &#123;</div><div class="line">        switch (mStatus) &#123;</div><div class="line">            case RUNNING:</div><div class="line">                throw new IllegalStateException(&quot;Cannot execute task:&quot;</div><div class="line">                        + &quot; the task is already running.&quot;);</div><div class="line">            case FINISHED:</div><div class="line">                throw new IllegalStateException(&quot;Cannot execute task:&quot;</div><div class="line">                        + &quot; the task has already been executed &quot;</div><div class="line">                        + &quot;(a task can be executed only once)&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mStatus = Status.RUNNING;</div><div class="line"></div><div class="line">    onPreExecute();</div><div class="line"></div><div class="line">    mWorker.mParams = params;</div><div class="line">    exec.execute(mFuture);</div><div class="line"></div><div class="line">    return this;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li>
</ul>
<p>不难看出，最后是调用Executor的<figure class="highlight plain"><figcaption><span>command)```方法启动mFuture。默认情况下，sDefaultExecutor就是SerialExecutor类，所以为串行执行。当然用户也可以提供自己的Executor来改变AsyncTask的运行方式。最后在```THREAD_POOL_EXECUTOR```真正启动任务执行的Executor。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">上面已经提到，Execute执行是调用Runnable的run()方法，也就是mFuture的run方法，继续跟进代码</div><div class="line">```java</div><div class="line">public void run() &#123;</div><div class="line">    if (state != NEW || !U.compareAndSwapObject(this, RUNNER, null, Thread.currentThread()))</div><div class="line">        return;</div><div class="line">    try &#123;</div><div class="line">        Callable&lt;V&gt; c = callable;</div><div class="line">        if (c != null &amp;&amp; state == NEW) &#123;</div><div class="line">            V result;</div><div class="line">            boolean ran;</div><div class="line">            try &#123;</div><div class="line">                result = c.call();</div><div class="line">                ran = true;</div><div class="line">            &#125; catch (Throwable ex) &#123;</div><div class="line">                result = null;</div><div class="line">                ran = false;</div><div class="line">                setException(ex);</div><div class="line">            &#125;</div><div class="line">            if (ran)</div><div class="line">                set(result);</div><div class="line">        &#125;</div><div class="line">    &#125; finally &#123;</div><div class="line">        runner = null;</div><div class="line">        int s = state;</div><div class="line">        if (s &gt;= INTERRUPTING)</div><div class="line">            handlePossibleCancellationInterrupt(s);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从第10行代码可发现，最后是调用callable的call()方法。那么这个callable是什么呢？就是初始化mFuture传入的mWorker对象。在前面的构造函数那边可以发现call()方法，我们单独分析一下这个方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">    Result result = doInBackground(mParams);</div><div class="line">    Binder.flushPendingCommands();</div><div class="line">    <span class="keyword">return</span> postResult(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看了这么久，终于发现了<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">```java</div><div class="line">private Result postResult(Result result) &#123;</div><div class="line">    Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</div><div class="line">            new AsyncTaskResult&lt;Result&gt;(this, result));</div><div class="line">    message.sendToTarget();</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以发现，最后是通过Handler的方式，把消息发送出去，消息中携带了<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">```java</div><div class="line">private static class InternalHandler extends Handler &#123;</div><div class="line">    public InternalHandler() &#123;</div><div class="line">        super(Looper.getMainLooper());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void handleMessage(Message msg) &#123;</div><div class="line">        AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</div><div class="line">        switch (msg.what) &#123;</div><div class="line">            case MESSAGE_POST_RESULT:</div><div class="line">                // There is only one result</div><div class="line">                result.mTask.finish(result.mData[0]);</div><div class="line">                break;</div><div class="line">            case MESSAGE_POST_PROGRESS:</div><div class="line">                result.mTask.onProgressUpdate(result.mData);</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里对消息的类型进行了判断，如果是MESSAGE_POST_RESULT，就执行<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">```java</div><div class="line">protected final void publishProgress(Progress... values) &#123;  </div><div class="line">    if (!isCancelled()) &#123;  </div><div class="line">        sHandler.obtainMessage(MESSAGE_POST_PROGRESS,  </div><div class="line">                new AsyncTaskResult&lt;Progress&gt;(this, values)).sendToTarget();  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后看一下finish()的代码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (isCancelled()) &#123;</div><div class="line">        onCancelled(result);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        onPostExecute(result);</div><div class="line">    &#125;</div><div class="line">    mStatus = Status.FINISHED;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>不难发现，如果当前任务被取消掉了，就会调用onCancelled()方法，如果没有被取消，则调用onPostExecute()方法，这样当前任务的执行就全部结束了。并且，当你再次调用execute的时候，这个时候mStatus的状态为Status.FINISHED，表示已经执行过了，那么此时就会抛异常，这也就是为什么一个AsyncTask对象只能执行一次的原因。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> (mStatus) &#123;</div><div class="line">    <span class="keyword">case</span> RUNNING:</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                + <span class="string">" the task is already running."</span>);</div><div class="line">    <span class="keyword">case</span> FINISHED:</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                + <span class="string">" the task has already been executed "</span></div><div class="line">                + <span class="string">"(a task can be executed only once)"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里，就非常清晰了吧。彻底的了解了AsyncTask内部实现的逻辑。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>可以看出，在使用AsyncTask的过程中，有许多需要注意的地方。</p>
<ol>
<li>由于Handler需要和主线程交互，而Handler又是内置于AsnycTask中的，所以，AsyncTask的创建必须在主线程，execute的执行也应该在主线程。</li>
<li>AsyncTask的doInBackground(Params… Params)方法运行在子线程中，其他方法运行在主线程中，可以操作UI组件。</li>
<li>尽量不要手动的去调用AsyncTask的onPreExecute, doInBackground, publishProgress, onProgressUpdate, onPostExecute 这些方法，避免发生不可预知的问题。</li>
<li>一个任务AsyncTask任务只能被执行一次。否则会抛IllegalStateException异常</li>
<li>在doInBackground()中要检查isCancelled()的返回值，如果你的异步任务是可以取消的话。cancel()仅仅是给AsyncTask对象设置了一个标识位，虽然运行中可以随时调用cancel(boolean mayInterruptIfRunning)方法取消任务，如果成功调用isCancelled()会返回true，并且不会执行 onPostExecute() 方法了，取而代之的是调用 onCancelled() 方法。但是！！！值得注意的一点是，如果这个任务在执行之后调用cancel()方法是不会真正的把任务结束的，而是继续执行，只不过改变的是执行之后的回调方法是 onPostExecute还是onCancelled。可以在doInBackground里面去判断isCancle，如果取消了，那就直接return result; 当然，这种方式也并非非常完美。</li>
<li>Asynctask的生命周期和它所在的activity的生命周期并非一致的，当Activity终止时，它会以它自有的方式继续运行，即使你退出了整个应用程序。另一方面，要注意Android屏幕切换问题，因为这时候Activity会重新创建。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/29/javascript-github-widget/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LeBron_Six">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/15133565?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LeBron_Six 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/29/javascript-github-widget/" itemprop="url">JS实现类似于微博秀的GitHub挂件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-29T21:13:04+08:00">
                2016-08-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>项目地址：<a href="https://github.com/smuyyh/GitHubWidgets" target="_blank" rel="external">https://github.com/smuyyh/GitHubWidgets</a></p>
<p>先来几张效果图。</p>
<ul>
<li><p>GitHub用户信息挂件<br><img src="https://github.com/smuyyh/GitHubWidgets/blob/master/screenshot/github_user_1.png?raw=true" width="210/"></p>
</li>
<li><p>GitHub代码库信息挂件<br><img src="https://github.com/smuyyh/GitHubWidgets/blob/master/screenshot/github_repo_1.png?raw=true" width="280/"></p>
</li>
<li><p>GitHub个人贡献信息挂件<br><img src="https://github.com/smuyyh/GitHubWidgets/blob/master/screenshot/github_activity_1.png?raw=true" width="280/"></p>
</li>
<li><p>为CSDN博客添加GitHub用户信息挂件<br><img src="https://github.com/smuyyh/GitHubWidgets/blob/master/screenshot/csdn_widget_2.png?raw=true" width="210/"></p>
</li>
</ul>
<h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><ul>
<li>User Widget</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"github-widget"</span> <span class="attr">data-username</span>=<span class="string">"smuyyh"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../js/github_user_widget_en.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li>Repo Widget</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"../js/jquery-1.7.1.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"../js/github_repo_widget_en.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"github-widget-repo"</span> <span class="attr">data-repo</span>=<span class="string">"smuyyh/SprintNBA"</span> <span class="attr">style</span>=<span class="string">"width:600px"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>or<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"../css/github_repo_widget_2.css"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"gitinfo"</span> <span class="attr">style</span>=<span class="string">"margin:15px 0; width:600px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../js/jquery-1.7.1.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined">var git_name ="/smuyyh/IncrementallyUpdate"</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"../js/github_repo_widget_2_en.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ul>
<li>Activity Widget</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"../css/github_widget_activity.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"widget-container"</span> <span class="attr">style</span>=<span class="string">"width:600px"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../js/jquery-1.7.1.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../js/github_widget_activity.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined">      $(function()&#123;</span></div><div class="line"><span class="undefined">        $('#widget-container').activity(&#123;</span></div><div class="line"><span class="undefined">          username: 'smuyyh'</span></div><div class="line"><span class="undefined">        &#125;);</span></div><div class="line"><span class="undefined">      &#125;);</span></div><div class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="为博客添加GitHub挂件（以CSDN博客为例）"><a href="#为博客添加GitHub挂件（以CSDN博客为例）" class="headerlink" title="为博客添加GitHub挂件（以CSDN博客为例）"></a>为博客添加GitHub挂件（以CSDN博客为例）</h2><p>管理博客 -&gt; 博客栏目 -&gt; 添加栏目<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"github-widget"</span> <span class="attr">data-username</span>=<span class="string">"smuyyh"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://rawgit.com/smuyyh/GitHubWidgets/master/js/github_user_widget_en.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!--js文件真实地址是以raw.githubusercontent.com开头，raw.githubusercontent.com在Response中设置了X-Content-Type-Options:nosniff ，</span></div><div class="line"><span class="comment">浏览器强制检查资源的MIME。解决方法就是将js链接中的raw.githubusercontent.com换成rawgit.com。  --&gt;</span></div></pre></td></tr></table></figure></p>
<p><img src="https://github.com/smuyyh/GitHubWidgets/blob/master/screenshot/csdn_widget_1.png?raw=true" alt="csdn"></p>
<h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p><img src="https://github.com/smuyyh/GitHubWidgets/blob/master/screenshot/csdn_widget_2.png?raw=true" width="210/"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/28/gradlew-command-not-found/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LeBron_Six">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/15133565?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LeBron_Six 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/28/gradlew-command-not-found/" itemprop="url">-bash ：gradlew command not found</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-28T21:13:04+08:00">
                2016-08-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>mac下执行gradlew命令时，提示-bash ：gradlew command not found，主要原因是Android Project根目录下地gradlew文件没有执行权限。打开终端，执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo chmod +x gradlew</div></pre></td></tr></table></figure>
<p>为gradlew增加可执行权限。</p>
<p>值得一提的是，mac下执行当前目录下的命令需要在前面加上“./”，否则会到环境变量下找相应命令。例如</p>
<pre><code>./gradlew javadocJar
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/25/android-bubble-popup-window/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LeBron_Six">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/15133565?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LeBron_Six 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/25/android-bubble-popup-window/" itemprop="url">Android 实现气泡布局/弹窗，可控制气泡尖角方向及偏移量</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-25T21:13:04+08:00">
                2016-08-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Android 自定义布局实现气泡弹窗，可控制气泡尖角方向及偏移量。</p>
<h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="http://img.blog.csdn.net/20160825143916306" width="280/"></p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>首先自定义一个气泡布局。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 气泡布局</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BubbleRelativeLayout</span> <span class="keyword">extends</span> <span class="title">RelativeLayout</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 气泡尖角方向</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> BubbleLegOrientation &#123;</div><div class="line">        TOP, LEFT, RIGHT, BOTTOM, NONE</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> PADDING = <span class="number">30</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> LEG_HALF_BASE = <span class="number">30</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> STROKE_WIDTH = <span class="number">2.0f</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> CORNER_RADIUS = <span class="number">8.0f</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> SHADOW_COLOR = Color.argb(<span class="number">100</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> MIN_LEG_DISTANCE = PADDING + LEG_HALF_BASE;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Paint mFillPaint = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Path mPath = <span class="keyword">new</span> Path();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Path mBubbleLegPrototype = <span class="keyword">new</span> Path();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Paint mPaint = <span class="keyword">new</span> Paint(Paint.DITHER_FLAG);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mBubbleLegOffset = <span class="number">0.75f</span>;</div><div class="line">    <span class="keyword">private</span> BubbleLegOrientation mBubbleOrientation = BubbleLegOrientation.LEFT;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BubbleRelativeLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BubbleRelativeLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BubbleRelativeLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyle);</div><div class="line">        init(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> Context context, <span class="keyword">final</span> AttributeSet attrs)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//setGravity(Gravity.CENTER);</span></div><div class="line"></div><div class="line">        ViewGroup.LayoutParams params = <span class="keyword">new</span> ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);</div><div class="line">        setLayoutParams(params);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (attrs != <span class="keyword">null</span>) &#123;</div><div class="line">            TypedArray a = context.obtainStyledAttributes(attrs, R.styleable.bubble);</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                PADDING = a.getDimensionPixelSize(R.styleable.bubble_padding, PADDING);</div><div class="line">                SHADOW_COLOR = a.getInt(R.styleable.bubble_shadowColor, SHADOW_COLOR);</div><div class="line">                LEG_HALF_BASE = a.getDimensionPixelSize(R.styleable.bubble_halfBaseOfLeg, LEG_HALF_BASE);</div><div class="line">                MIN_LEG_DISTANCE = PADDING + LEG_HALF_BASE;</div><div class="line">                STROKE_WIDTH = a.getFloat(R.styleable.bubble_strokeWidth, STROKE_WIDTH);</div><div class="line">                CORNER_RADIUS = a.getFloat(R.styleable.bubble_cornerRadius, CORNER_RADIUS);</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</div><div class="line">                    a.recycle();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mPaint.setColor(SHADOW_COLOR);</div><div class="line">        mPaint.setStyle(Style.FILL);</div><div class="line">        mPaint.setStrokeCap(Cap.BUTT);</div><div class="line">        mPaint.setAntiAlias(<span class="keyword">true</span>);</div><div class="line">        mPaint.setStrokeWidth(STROKE_WIDTH);</div><div class="line">        mPaint.setStrokeJoin(Paint.Join.MITER);</div><div class="line">        mPaint.setPathEffect(<span class="keyword">new</span> CornerPathEffect(CORNER_RADIUS));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">11</span>) &#123;</div><div class="line">            setLayerType(LAYER_TYPE_SOFTWARE, mPaint);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mFillPaint = <span class="keyword">new</span> Paint(mPaint);</div><div class="line">        mFillPaint.setColor(Color.WHITE);</div><div class="line">        mFillPaint.setShader(<span class="keyword">new</span> LinearGradient(<span class="number">100f</span>, <span class="number">0f</span>, <span class="number">100f</span>, <span class="number">200f</span>, Color.WHITE, Color.WHITE, TileMode.CLAMP));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">11</span>) &#123;</div><div class="line">            setLayerType(LAYER_TYPE_SOFTWARE, mFillPaint);</div><div class="line">        &#125;</div><div class="line">        mPaint.setShadowLayer(<span class="number">2f</span>, <span class="number">2F</span>, <span class="number">5F</span>, SHADOW_COLOR);</div><div class="line"></div><div class="line">        renderBubbleLegPrototype();</div><div class="line"></div><div class="line">        setPadding(PADDING, PADDING, PADDING, PADDING);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration newConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onConfigurationChanged(newConfig);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 尖角path</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">renderBubbleLegPrototype</span><span class="params">()</span> </span>&#123;</div><div class="line">        mBubbleLegPrototype.moveTo(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">        mBubbleLegPrototype.lineTo(PADDING * <span class="number">1.5f</span>, -PADDING / <span class="number">1.5f</span>);</div><div class="line">        mBubbleLegPrototype.lineTo(PADDING * <span class="number">1.5f</span>, PADDING / <span class="number">1.5f</span>);</div><div class="line">        mBubbleLegPrototype.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBubbleParams</span><span class="params">(<span class="keyword">final</span> BubbleLegOrientation bubbleOrientation, <span class="keyword">final</span> <span class="keyword">float</span> bubbleOffset)</span> </span>&#123;</div><div class="line">        mBubbleLegOffset = bubbleOffset;</div><div class="line">        mBubbleOrientation = bubbleOrientation;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 根据显示方向，获取尖角位置矩阵</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> width</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> height</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> Matrix <span class="title">renderBubbleLegMatrix</span><span class="params">(<span class="keyword">final</span> <span class="keyword">float</span> width, <span class="keyword">final</span> <span class="keyword">float</span> height)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">float</span> offset = Math.max(mBubbleLegOffset, MIN_LEG_DISTANCE);</div><div class="line"></div><div class="line">        <span class="keyword">float</span> dstX = <span class="number">0</span>;</div><div class="line">        <span class="keyword">float</span> dstY = Math.min(offset, height - MIN_LEG_DISTANCE);</div><div class="line">        <span class="keyword">final</span> Matrix matrix = <span class="keyword">new</span> Matrix();</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (mBubbleOrientation) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> TOP:</div><div class="line">                dstX = Math.min(offset, width - MIN_LEG_DISTANCE);</div><div class="line">                dstY = <span class="number">0</span>;</div><div class="line">                matrix.postRotate(<span class="number">90</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> RIGHT:</div><div class="line">                dstX = width;</div><div class="line">                dstY = Math.min(offset, height - MIN_LEG_DISTANCE);</div><div class="line">                matrix.postRotate(<span class="number">180</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> BOTTOM:</div><div class="line">                dstX = Math.min(offset, width - MIN_LEG_DISTANCE);</div><div class="line">                dstY = height;</div><div class="line">                matrix.postRotate(<span class="number">270</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        matrix.postTranslate(dstX, dstY);</div><div class="line">        <span class="keyword">return</span> matrix;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">float</span> width = canvas.getWidth();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">float</span> height = canvas.getHeight();</div><div class="line"></div><div class="line">        mPath.rewind();</div><div class="line">        mPath.addRoundRect(<span class="keyword">new</span> RectF(PADDING, PADDING, width - PADDING, height - PADDING), CORNER_RADIUS, CORNER_RADIUS, Direction.CW);</div><div class="line">        mPath.addPath(mBubbleLegPrototype, renderBubbleLegMatrix(width, height));</div><div class="line"></div><div class="line">        canvas.drawPath(mPath, mPaint);</div><div class="line">        canvas.scale((width - STROKE_WIDTH) / width, (height - STROKE_WIDTH) / height, width / <span class="number">2f</span>, height / <span class="number">2f</span>);</div><div class="line"></div><div class="line">        canvas.drawPath(mPath, mFillPaint);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>样式 attrs.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"bubble"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"shadowColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"padding"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"strokeWidth"</span> <span class="attr">format</span>=<span class="string">"float"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"cornerRadius"</span> <span class="attr">format</span>=<span class="string">"float"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"halfBaseOfLeg"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>然后自定义一个PopupWindow，用于显示气泡。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BubblePopupWindow</span> <span class="keyword">extends</span> <span class="title">PopupWindow</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> BubbleRelativeLayout bubbleView;</div><div class="line">    <span class="keyword">private</span> Context context;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BubblePopupWindow</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.context = context;</div><div class="line">        setWidth(ViewGroup.LayoutParams.WRAP_CONTENT);</div><div class="line">        setHeight(ViewGroup.LayoutParams.WRAP_CONTENT);</div><div class="line"></div><div class="line">        setFocusable(<span class="keyword">true</span>);</div><div class="line">        setOutsideTouchable(<span class="keyword">false</span>);</div><div class="line">        setClippingEnabled(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        ColorDrawable dw = <span class="keyword">new</span> ColorDrawable(<span class="number">0</span>);</div><div class="line">        setBackgroundDrawable(dw);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBubbleView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        bubbleView = <span class="keyword">new</span> BubbleRelativeLayout(context);</div><div class="line">        bubbleView.setBackgroundColor(Color.TRANSPARENT);</div><div class="line">        bubbleView.addView(view);</div><div class="line">        setContentView(bubbleView);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParam</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">        setWidth(width);</div><div class="line">        setHeight(height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(View parent)</span> </span>&#123;</div><div class="line">        show(parent, Gravity.TOP, getMeasuredWidth() / <span class="number">2</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(View parent, <span class="keyword">int</span> gravity)</span> </span>&#123;</div><div class="line">        show(parent, gravity, getMeasuredWidth() / <span class="number">2</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 显示弹窗</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> parent</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> gravity</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> bubbleOffset 气泡尖角位置偏移量。默认位于中间</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(View parent, <span class="keyword">int</span> gravity, <span class="keyword">float</span> bubbleOffset)</span> </span>&#123;</div><div class="line">        BubbleRelativeLayout.BubbleLegOrientation orientation = BubbleRelativeLayout.BubbleLegOrientation.LEFT;</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.isShowing()) &#123;</div><div class="line">            <span class="keyword">switch</span> (gravity) &#123;</div><div class="line">                <span class="keyword">case</span> Gravity.BOTTOM:</div><div class="line">                    orientation = BubbleRelativeLayout.BubbleLegOrientation.TOP;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> Gravity.TOP:</div><div class="line">                    orientation = BubbleRelativeLayout.BubbleLegOrientation.BOTTOM;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> Gravity.RIGHT:</div><div class="line">                    orientation = BubbleRelativeLayout.BubbleLegOrientation.LEFT;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> Gravity.LEFT:</div><div class="line">                    orientation = BubbleRelativeLayout.BubbleLegOrientation.RIGHT;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            bubbleView.setBubbleParams(orientation, bubbleOffset); <span class="comment">// 设置气泡布局方向及尖角偏移</span></div><div class="line"></div><div class="line">            <span class="keyword">int</span>[] location = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</div><div class="line">            parent.getLocationOnScreen(location);</div><div class="line"></div><div class="line">            <span class="keyword">switch</span> (gravity) &#123;</div><div class="line">                <span class="keyword">case</span> Gravity.BOTTOM:</div><div class="line">                    showAsDropDown(parent);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> Gravity.TOP:</div><div class="line">                    showAtLocation(parent, Gravity.NO_GRAVITY, location[<span class="number">0</span>], location[<span class="number">1</span>] - getMeasureHeight());</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> Gravity.RIGHT:</div><div class="line">                    showAtLocation(parent, Gravity.NO_GRAVITY, location[<span class="number">0</span>] + parent.getWidth(), location[<span class="number">1</span>] - (parent.getHeight() / <span class="number">2</span>));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> Gravity.LEFT:</div><div class="line">                    showAtLocation(parent, Gravity.NO_GRAVITY, location[<span class="number">0</span>] - getMeasuredWidth(), location[<span class="number">1</span>] - (parent.getHeight() / <span class="number">2</span>));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.dismiss();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 测量高度</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMeasureHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">        getContentView().measure(View.MeasureSpec.UNSPECIFIED, View.MeasureSpec.UNSPECIFIED);</div><div class="line">        <span class="keyword">int</span> popHeight = getContentView().getMeasuredHeight();</div><div class="line">        <span class="keyword">return</span> popHeight;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 测量宽度</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMeasuredWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">        getContentView().measure(View.MeasureSpec.UNSPECIFIED, View.MeasureSpec.UNSPECIFIED);</div><div class="line">        <span class="keyword">int</span> popWidth = getContentView().getMeasuredWidth();</div><div class="line">        <span class="keyword">return</span> popWidth;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>view_popup_window.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">com.yuyh.library.BubbleRelativeLayout</span></span></div><div class="line"><span class="tag">	<span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/brlBackground"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">"@android:color/transparent"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:cornerRadius</span>=<span class="string">"10"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:halfBaseOfLeg</span>=<span class="string">"18dp"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:padding</span>=<span class="string">"18dp"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:shadowColor</span>=<span class="string">"#64000000"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:strokeWidth</span>=<span class="string">"5"</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">com.yuyh.library.BubbleRelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">BubblePopupWindow leftTopWindow = <span class="keyword">new</span> BubblePopupWindow(MainActivity.<span class="keyword">this</span>);</div><div class="line">View bubbleView = inflater.inflate(R.layout.layout_popup_view, <span class="keyword">null</span>);</div><div class="line">TextView tvContent = (TextView) bubbleView.findViewById(R.id.tvContent);</div><div class="line">tvContent.setText(<span class="string">"HelloWorld"</span>);</div><div class="line">leftTopWindow.setBubbleView(bubbleView); <span class="comment">// 设置气泡内容</span></div><div class="line">leftTopWindow.show(view, Gravity.BOTTOM, <span class="number">0</span>); <span class="comment">// 显示弹窗</span></div></pre></td></tr></table></figure>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.yuyh.bubble:library:1.0.0&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p><a href="https://github.com/smuyyh/BubblePopupWindow" target="_blank" rel="external">https://github.com/smuyyh/BubblePopupWindow</a></p>
<div class="github-widget-repo" data-repo="smuyyh/BubblePopupWindow" style="width:600px"></div>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/16/java-coding-standard/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LeBron_Six">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/15133565?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LeBron_Six 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/16/java-coding-standard/" itemprop="url">Java 代码规范初步</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-16T21:13:04+08:00">
                2016-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>谈到编码规范，对于团队项目开发来说，是很有必要的。如果说代码是一种社会行为，那么代码规范可以说是法律，通过法律来约束行为。养成一个良好编码规范的习惯，一是可以统一代码风格；二是便于团队成员协作开发；三是在review代码的时候，更加容易精确地判断需要修改的地方；四是提高代码的可读性和可维护性，提高编码效率及代码质量。</p>
<p>写代码就像写文章一样，逻辑调理清晰，在合适的地方分段，这样对方看起来也比较舒服。当然，以下一些规范是个人整理出来的一些建议，也并非绝对正确，欢迎提议，不喜勿喷~~</p>
<h2 id="文件编码"><a href="#文件编码" class="headerlink" title="文件编码"></a>文件编码</h2><p>为了使插件开发应用能有更好的国际化支持，能够最大程度的支持中文输出，则最好使 Java文件使用UTF-8编码。换行符统一为windows格式。不管是Eclipse还是AS，把IDE的环境配好是首当其冲的。</p>
<h2 id="排版规范"><a href="#排版规范" class="headerlink" title="排版规范"></a>排版规范</h2><ul>
<li>缩进：也可以理解为代码对齐，正常情况下代码保存提交时，应该先让代码按统一样式对齐，默认对齐样式在Eclipse中快捷键是Ctrl(Command)+Shift+F，AS是Ctrl(Command)+Alt+L；</li>
<li>分界符：如”{“与”}”，一般遵循“{”前面不换行，后面换行，”}”前后都换行；</li>
<li>语句分割：单行代码太长的话应考虑分割，例如在 “if” 判断条件中，如果逻辑判断的条件太长，分割的原则尽可能是每部分逻辑判断单独一行，有利于代码可读性；属性或者方法之间有较强相关性的，可以放在一起，尽量不要交叉放置。</li>
<li>换行：不要为了怕代码太长而不换行，把一堆代码混在一起。<ul>
<li>一行只写一条语句，不要多条语句写在同一行； </li>
<li>if、for、do、while、case、switch、default等语句，最好独自占一行； </li>
<li>在同一个方法里面，逻辑或属性相对独立的代码块之间应加个换行；</li>
</ul>
</li>
<li><p>空格：</p>
<ul>
<li>“，”后面要加个空格； </li>
<li><p>比较操作符(“&gt;”,”&lt;”,”==”)、赋值操作符(“=”,”+=”)，算术操作符(“+”,”%”)，逻辑操作符(“&amp;&amp;”,”&amp;”,”||”)，位操作符(“&lt;&lt;”,”^”)等双目操作符的前后面加空格； </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if (value &gt;= MAX_VALUE) &#123;</div><div class="line">    a = b + c;</div><div class="line">    a *= 2;</div><div class="line">    a = b ^ 2; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>“！”、”~”、”++”、”–”等单目操作符前后不加空格</p>
</li>
<li>if、for、while、switch等与后面的括号之间应加空格，使if等关键字更为突出、明显。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">if (a &gt;= b &amp;&amp; c &gt; d) &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="注释规范"><a href="#注释规范" class="headerlink" title="注释规范"></a>注释规范</h2><ul>
<li>一般情况下，源程序有效注释亮须在20%以上，注释不宜过多，也不能太少，注释须精准易懂，言简意赅。</li>
<li><p>文件注释：从Java文件第一行开始，为避免被JavaDoc收集，以 /* 开始，以 */ 结束（JavaDoc收集的注释内容以 /** 开始），中间每一行前面加一个“*”。一般是一些版权信息、描述信息及License。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">    * Copyright (c) 2016, smuyyh@gmail.com All Rights Reserved.</div><div class="line">    */</div></pre></td></tr></table></figure>
</li>
<li><p>类注释：以 /** 开头， 在Class、Interface、Enum之前。一般是用一句话描述类用途，也可有作者及时间等信息，这类信息不宜过多。</p>
</li>
<li><p>属性注释：以 /** 开头。有时也可以直接写在一行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 注释信息</div><div class="line"> */</div><div class="line">private static final int TEXT_COLOR = Color.RED;</div><div class="line">/** 注释信息 */</div><div class="line">private static final int BG_COLOR = Color.RED;</div></pre></td></tr></table></figure>
</li>
<li><p>方法注释：@since表明从那个版本开始就有这个方法；@exception或throws可能的异常；@deprecated表示不建议使用该方法。异常注释用@exception或@throws表示，在JavaDoc中二者等价，但推荐用@exception标注Runtime异常，@throws标注非Runtime异常。异常的注释必须说明该异常的含义及什么条件下抛出该异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">* 方法描述</div><div class="line">* @param   [参数1]   [参数1说明]</div><div class="line">* @param   [参数2]   [参数2说明]</div><div class="line">* @return  [返回类型说明]</div><div class="line">* @exception/throws    [违例类型]   [违例说明]</div><div class="line">* @see     [类、类#方法、类#成员]</div><div class="line">* @deprecated   [说明及原因]</div><div class="line">*/</div><div class="line">public int method(String arg1, String agr2) throws Exception&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>对变量的定义和分支语句（条件分支、循环语句等），稍微复杂一点的最好编写注释，因为这些语句往往是程序实现某一特定功能的关键，对于维护人员来说，良好的注释帮助更好的理解程序，有时甚至优于看设计文档。</p>
</li>
<li>对于switch语句下的case语句，如果因为特殊情况需要处理完一个case后需进入下一个case处理，最好在该case语句处理完、下一个case语句前加上明确的注释，这样比较清楚程序编写者的意图，有效防止无辜遗漏break语句</li>
<li>边写代码边注释，修改代码同时修改相应注释，以保证注释与代码的一致性。更新代码须和更新注释保持同步。</li>
<li>注释的内容要清晰、明了，含义明确，防止注释二义性，错误的注释不但无益反而有害。</li>
<li>尽量避免在注释中使用缩写，特别是不常用缩写。</li>
</ul>
<h2 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h2><ul>
<li>包名：包名全部小写，连续的单词只是简单地连接起来，不使用下划线</li>
<li>类名和接口：使用类意义完整的英文描述（如单词太长，可以考虑简写，但尽可能是通俗的简写），每个英文单词的首字母使用大写、其余字母使用小写的大小写混合法</li>
<li>方法名：第一个单词的字母使用小写、剩余单词首字母大写其余字母小写</li>
<li>属性名：规则与方法名类似，但值不能相同。</li>
<li>常量名：使用全大写的英文描述，英文单词之间用下划线分隔开，并且使用final static修饰</li>
<li>准确的确定成员函数的存取控制符号，不是必须使用public属性的，就使用protected，不是必须使用protected的，就使用private</li>
</ul>
<h2 id="编码准则"><a href="#编码准则" class="headerlink" title="编码准则"></a>编码准则</h2><ul>
<li>明确方法功能，精确（而不是近似）地实现方法设计。一个函数仅完成一件功能，即使简单功能也应该编写方法实现。虽然为仅用一两行就可完成的功能去编方法好像没有必要，但用方法可使功能明确化，增加程序可读性，亦可方便维护、测试。</li>
<li>明确规定对接口方法参数的合法性检查应由方法的调用者负责还是由接口方法本身负责，缺省是由方法调用者负责。</li>
<li><p>明确类的功能，精确（而非近似）地实现类的设计。一个类仅实现一组相近的功能。可以认为是迪米特法则。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> public MessageBean&#123;</div><div class="line">        private String message;</div><div class="line">    </div><div class="line">        public String toString()&#123;</div><div class="line">            return&quot;message:&quot; + message;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>DB、IO操作等需要使用结束close()的对象必须在try-catch-finally的finally中close()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> try&#123;</div><div class="line">        //... ...</div><div class="line">&#125; catch(IOException e)&#123;</div><div class="line">        //... ...</div><div class="line">&#125; finally&#123;</div><div class="line">        try&#123;</div><div class="line">            out.close();</div><div class="line">        &#125; catch (IOException e)&#123;</div><div class="line">            //... ...</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>异常捕获后，如果不对该异常进行处理，则应该记录日志或者ex.printStackTrace()</p>
</li>
<li><p>自己抛出的异常必须要填写详细的描述信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">throw new IOException(&quot;Writing data error!Data:&quot; + data.toString());</div></pre></td></tr></table></figure>
</li>
<li><p>注意运算符的优先级，并用括号明确表达式的操作顺序，避免使用默认优先级</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">if ((a | b) &amp;&amp; (a &amp; c))</div><div class="line">        word = (high &lt;&lt; 8) | low;</div></pre></td></tr></table></figure>
</li>
<li><p>避免使用不易理解的数字，用有意义的标识来代替。涉及物理状态或者含有物理意义的常量，不应直接使用数字，必须用有意义的静态变量来代替。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">private final static int OPEN = 0;</div><div class="line">private final static int CLOSE = 1;</div><div class="line">private final static int UNKNOW = -1;</div><div class="line"></div><div class="line">if (state = CLOSE)&#123;</div><div class="line">       state = OPEN;</div><div class="line">       //...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>数组声明的时候使用int[] index，有利于提高可读性，而不要使用int index[]。</p>
</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul>
<li>在switch 中每个case语句都应该包含break或者return，否则需要进行注释，避免遗漏。为switch语句提供一个default选项。</li>
<li>不要使用空的for、if、while语句</li>
<li>在运算中尽可能不要减小数据的精度。例如由double转为float，可能会遗失一部分，降低精度。</li>
<li>避免在if语句中使用等号=进行赋值操作</li>
<li>方法重载的时候，一定要注意方法名相同，避免类中使用两个非常相似的方法名。</li>
<li>不要覆盖父类的静态方法和私有方法，也不要覆盖父类的属性。</li>
<li>不要使用两层嵌套以上的内部类</li>
<li>去掉接口中多余的定义（不使用public，abstract，static，final等，这是接口中默认的）</li>
<li>尽可能不要定义不会被用到的局部变量、类私有属性、类私有方法和方法参数</li>
<li>进行字符转换的时候应该尽可能的减少临时变量。</li>
<li>尽可能不要对浮点数进行比较运算，尤其是不要进行==，！=，容易出错。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/13/mac-library-to-jcenter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LeBron_Six">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/15133565?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LeBron_Six 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/13/mac-library-to-jcenter/" itemprop="url">利用Gradle发布项目到JCenter</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-13T21:13:04+08:00">
                2016-07-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Android Studio将远程仓库默认指定为Jcenter仓库，位于Bintray网站。Bintray网站下面还有其他好几个仓库。本文主要介绍如何将Android项目发布到Jcenter。</p>
<h2 id="注册Bintray账号"><a href="#注册Bintray账号" class="headerlink" title="注册Bintray账号"></a>注册Bintray账号</h2><p>Bintray官网：<a href="https://bintray.com" target="_blank" rel="external">https://bintray.com</a></p>
<p><div align="center"><br><img src="http://img.blog.csdn.net/20160713202236653?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" width="780" alt="注册账号" align="center"></div></p>
<p>也可使用GitHub账号登录。</p>
<hr>
<h2 id="获取APIKey"><a href="#获取APIKey" class="headerlink" title="获取APIKey"></a>获取APIKey</h2><p>上传项目之前我们需要两样东西，一个就是用户名，另一个是APIKey。APIKey可在<a href="https://bintray.com/profile/edit" target="_blank" rel="external">这里</a>查看。</p>
<p><div align="center"><br><img src="http://img.blog.csdn.net/20160713202940528?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" width="780" alt="注册账号" align="center"></div></p>
<p>点击show便可显示。</p>
<hr>
<h2 id="插件依赖"><a href="#插件依赖" class="headerlink" title="插件依赖"></a>插件依赖</h2><p>在项目最外层的build.gradle添加“gradle-bintray-plugin”以及“android-maven-plugin”插件的依赖。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        classpath &apos;com.android.tools.build:gradle:2.1.0&apos;</div><div class="line">        classpath &apos;com.github.dcendents:android-maven-gradle-plugin:1.3&apos;</div><div class="line">        classpath &apos;com.jfrog.bintray.gradle:gradle-bintray-plugin:1.0&apos;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">allprojects &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="Module配置"><a href="#Module配置" class="headerlink" title="Module配置"></a>Module配置</h2><p>在需要发布到Jcenter的module（比如library）的build.gradle里配置以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line">apply plugin: &apos;com.android.library&apos;</div><div class="line">apply plugin: &apos;com.github.dcendents.android-maven&apos;</div><div class="line">apply plugin: &apos;com.jfrog.bintray&apos;</div><div class="line">version = &quot;1.0.0&quot; // 版本号</div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion 23</div><div class="line">    buildToolsVersion &quot;23.0.3&quot;</div><div class="line">    resourcePrefix &quot;bankcardformat&quot; // 随意命名</div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion 15</div><div class="line">        targetSdkVersion 23</div><div class="line">        versionCode 1</div><div class="line">        versionName &quot;1.0&quot;</div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled false</div><div class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.android.support:appcompat-v7:23.+&apos;</div><div class="line">    compile fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</div><div class="line">&#125;</div><div class="line"></div><div class="line">def siteUrl = &apos;https://github.com/smuyyh/BankCardFormat&apos;    // Git项目主页</div><div class="line">def gitUrl = &apos;https://github.com/smuyyh/BankCardFormat.git&apos; // Git仓库url</div><div class="line">group = &quot;com.yuyh.bankcardformat&quot; // 一般为包名</div><div class="line"></div><div class="line">install &#123;</div><div class="line">    repositories.mavenInstaller &#123;</div><div class="line">        // 生成POM.xml</div><div class="line">        pom &#123;</div><div class="line">            project &#123;</div><div class="line">                packaging &apos;aar&apos;</div><div class="line">                name &apos;Android BankCardFormat&apos; // 项目描述</div><div class="line">                url siteUrl</div><div class="line">                licenses &#123;</div><div class="line">                    license &#123;</div><div class="line">                        name &apos;The Apache Software License, Version 2.0&apos;</div><div class="line">                        url &apos;http://www.apache.org/licenses/LICENSE-2.0.txt&apos;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                developers &#123;</div><div class="line">                    developer &#123; // 开发者个人信息</div><div class="line">                        id &apos;smuyyh&apos;</div><div class="line">                        name &apos;smuyyh&apos;</div><div class="line">                        email &apos;smuyyh@gmail.com&apos;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                scm &#123;</div><div class="line">                    connection gitUrl</div><div class="line">                    developerConnection gitUrl</div><div class="line">                    url siteUrl</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">task sourcesJar(type: Jar) &#123;</div><div class="line">    from android.sourceSets.main.java.srcDirs</div><div class="line">    classifier = &apos;sources&apos;</div><div class="line">&#125;</div><div class="line">task javadoc(type: Javadoc) &#123;</div><div class="line">    options.encoding = &quot;UTF-8&quot; // 设置编码，否则中文可能会提示出错</div><div class="line">    source = android.sourceSets.main.java.srcDirs</div><div class="line">    classpath += project.files(android.getBootClasspath().join(File.pathSeparator))</div><div class="line">&#125;</div><div class="line">task javadocJar(type: Jar, dependsOn: javadoc) &#123;</div><div class="line">    classifier = &apos;javadoc&apos;</div><div class="line">    from javadoc.destinationDir</div><div class="line">&#125;</div><div class="line">artifacts &#123;</div><div class="line">    archives javadocJar</div><div class="line">    archives sourcesJar</div><div class="line">&#125;</div><div class="line">Properties properties = new Properties()</div><div class="line">properties.load(project.rootProject.file(&apos;local.properties&apos;).newDataInputStream())</div><div class="line">bintray &#123;</div><div class="line">    user = properties.getProperty(&quot;bintray.user&quot;)</div><div class="line">    key = properties.getProperty(&quot;bintray.apikey&quot;)</div><div class="line">    configurations = [&apos;archives&apos;]</div><div class="line">    pkg &#123;</div><div class="line">        repo = &quot;maven&quot; // 发布到Maven库</div><div class="line">        name = &quot;BankCardFormat&quot; // 发布到JCenter上的项目名字</div><div class="line">        websiteUrl = siteUrl</div><div class="line">        vcsUrl = gitUrl</div><div class="line">        licenses = [&quot;Apache-2.0&quot;]</div><div class="line">        publish = true</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="配置Username和APIKey"><a href="#配置Username和APIKey" class="headerlink" title="配置Username和APIKey"></a>配置Username和APIKey</h2><p>在local.properties文件配置Username和APIKey。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bintray.user = xxxx</div><div class="line">bintray.apikey = xxxx</div></pre></td></tr></table></figure></p>
<p>正常情况下local.properties应该加入到.gitignore文件里，因为这两项属于隐私信息，无需上传到GitHub。当然了，也可把bintray.user及bintray.apiKey配置在Gradle用户目录下的gradle.properties(不存在则新建)，例如Windows是在C:/user/username/.gradle，OSX和Linux在~/.gradle</p>
<hr>
<h2 id="ReBuild"><a href="#ReBuild" class="headerlink" title="ReBuild"></a>ReBuild</h2><p>Rebuild一下项目，会发现在/build/outputs/aar下生成两个文件，这就是library打包出来的二进制文件。</p>
<hr>
<h2 id="上传项目到Jcenter"><a href="#上传项目到Jcenter" class="headerlink" title="上传项目到Jcenter"></a><span id="anchor">上传项目到Jcenter</span></h2><p>在Android Studio的Terminal执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">gradlew javadocJar</div><div class="line">gradlew sourcesJar</div><div class="line">gradlew install</div><div class="line">gradlew bintrayUpload</div></pre></td></tr></table></figure>
<p>执行成功之后，在Bintray个人主页下面可以看到Maven多了一个Package。</p>
<p><div align="center"><br><img src="http://img.blog.csdn.net/20160713205525775?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" width="780" alt="注册账号" align="center"></div></p>
<p>点击进去可看到刚刚上传的项目</p>
<p><div align="center"><br><img src="http://img.blog.csdn.net/20160713205544104?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" width="780" alt="注册账号" align="center"></div></p>
<hr>
<h2 id="申请项目加入Jcenter"><a href="#申请项目加入Jcenter" class="headerlink" title="申请项目加入Jcenter"></a>申请项目加入Jcenter</h2><p>申请地址：<a href="https://bintray.com/bintray/jcenter" target="_blank" rel="external">https://bintray.com/bintray/jcenter</a><br>搜索刚刚上传的项目，并选中。或者进入项目主页，点击右下角“Add to Jcenter”</p>
<p><div align="center"><br><img src="http://img.blog.csdn.net/20160713205907464?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" width="780" alt="注册账号" align="center"></div></p>
<p>输入项目描述，完成。</p>
<p><div align="center"><br><img src="http://img.blog.csdn.net/20160713210606947?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" width="780" alt="注册账号" align="center"></div></p>
<hr>
<h2 id="等待审核"><a href="#等待审核" class="headerlink" title="等待审核"></a>等待审核</h2><p>审核速度挺快，一般几个小时左右会通过。Bintray会向您发送一条成功的信息。那么就完成上传了。</p>
<p><div align="center"><br><img src="http://img.blog.csdn.net/20160714085637027" width="780" alt="注册账号" align="center"></div></p>
<hr>
<h2 id="项目依赖"><a href="#项目依赖" class="headerlink" title="项目依赖"></a>项目依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.yuyh.bankcardformat:library:1.0.0&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="项目更新"><a href="#项目更新" class="headerlink" title="项目更新"></a>项目更新</h2><p>上传的库进行升级的时候，须更改build.gradle下的version、versionCode、versionName，否则无法进行打包上传。更改完之后重新执行<a href="#anchor">上传项目到Jcenter</a>步骤。上传完成可在项目主页下看到更新的版本号。</p>
<p><div align="center"><br><img src="http://img.blog.csdn.net/20160714092328928" width="780" alt="注册账号" align="center"></div></p>
<hr>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>若在上传的时候，出现GBK编码错误，尝试在task javadoc(type: Javadoc) 下设置UTF-8编码：<br>options.encoding = “UTF-8”<br>无法解决请参考以下这个Gradle文件的配置：<br><a href="https://github.com/msdx/gradle-publish/blob/master/bintray.gradle" target="_blank" rel="external">https://github.com/msdx/gradle-publish/blob/master/bintray.gradle</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/28/android-crash-handler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LeBron_Six">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/15133565?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LeBron_Six 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/28/android-crash-handler/" itemprop="url">Android 全局异常捕获之CrashHandler</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-01-28T21:13:04+08:00">
                2016-01-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一个App上线或者投入到生产环境的时候崩溃了，还不知道是什么原因，这肯定是开发者的痛…所以肯定要加入全局异常捕获，如果项目较大的话，可以考虑加入第三方诸如友盟的崩溃统计插件，以达到异常捕获的效果！</p>
<p>Crash，可以理解为崩溃、垮台，通常来讲就是App运行期间发生了不可预料的错误，虽然在经历发布之前，测试人员进行了大量的测试，但是并不能保证App的正常运行，总会或多或少有一些BUG的。</p>
<p>Java的Thread中有一个UncaughtExceptionHandler接口，该接口的作用主要是为了当Thread 因未捕获的异常而突然终止时，调用处理程序。我们可以通过setDefaultUncaughtExceptionHandler方法，来改变异常默认处理程序。<br>实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"><span class="keyword">import</span> android.content.pm.PackageInfo;</div><div class="line"><span class="keyword">import</span> android.content.pm.PackageManager;</div><div class="line"><span class="keyword">import</span> android.content.pm.PackageManager.NameNotFoundException;</div><div class="line"><span class="keyword">import</span> android.os.Build;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.PrintWriter;</div><div class="line"><span class="keyword">import</span> java.io.StringWriter;</div><div class="line"><span class="keyword">import</span> java.io.Writer;</div><div class="line"><span class="keyword">import</span> java.lang.Thread.UncaughtExceptionHandler;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Field;</div><div class="line"><span class="keyword">import</span> java.text.DateFormat;</div><div class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * UncaughtException处理类,当程序发生Uncaught异常的时候,有该类来接管程序,并记录发送错误报告.</span></div><div class="line"><span class="comment"> * &lt;p&gt;</span></div><div class="line"><span class="comment"> * Created by yuyuhang on 15/12/7.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CrashHandler</span> <span class="keyword">implements</span> <span class="title">UncaughtExceptionHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//系统默认的UncaughtException处理类</span></div><div class="line">    <span class="keyword">private</span> Thread.UncaughtExceptionHandler mDefaultHandler;</div><div class="line">    <span class="comment">//CrashHandler实例</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CrashHandler INSTANCE;</div><div class="line">    <span class="comment">//程序的Context对象</span></div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line">    <span class="comment">//用来存储设备信息和异常信息</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; infos = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">CrashHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取CrashHandler实例 ,单例模式</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CrashHandler <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>)</div><div class="line">            INSTANCE = <span class="keyword">new</span> CrashHandler();</div><div class="line">        <span class="keyword">return</span> INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 初始化</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        mContext = context;</div><div class="line">        <span class="comment">//获取系统默认的UncaughtException处理器</span></div><div class="line">        mDefaultHandler = Thread.getDefaultUncaughtExceptionHandler();</div><div class="line">        <span class="comment">//设置该CrashHandler为程序的默认处理器</span></div><div class="line">        Thread.setDefaultUncaughtExceptionHandler(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 当UncaughtException发生时会转入该函数来处理</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread thread, Throwable ex)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!handleException(ex) &amp;&amp; mDefaultHandler != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//如果用户没有处理则让系统默认的异常处理器来处理</span></div><div class="line">            mDefaultHandler.uncaughtException(thread, ex);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">3000</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                LogUtils.e(e.toString());</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//退出程序</span></div><div class="line">            android.os.Process.killProcess(android.os.Process.myPid());</div><div class="line">            System.exit(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 自定义错误处理,收集错误信息 发送错误报告等操作均在此完成.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> ex</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> true:如果处理了该异常信息;否则返回false.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">handleException</span><span class="params">(Throwable ex)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (ex == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//收集设备参数信息</span></div><div class="line">        collectDeviceInfo(mContext);</div><div class="line">        <span class="comment">//保存日志文件</span></div><div class="line">        saveCrashInfo2File(ex);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 收集设备参数信息</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">collectDeviceInfo</span><span class="params">(Context ctx)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            PackageManager pm = ctx.getPackageManager();</div><div class="line">            PackageInfo pi = pm.getPackageInfo(ctx.getPackageName(), PackageManager.GET_ACTIVITIES);</div><div class="line">            <span class="keyword">if</span> (pi != <span class="keyword">null</span>) &#123;</div><div class="line">                String versionName = pi.versionName == <span class="keyword">null</span> ? <span class="string">"null"</span> : pi.versionName;</div><div class="line">                String versionCode = pi.versionCode + <span class="string">""</span>;</div><div class="line">                infos.put(<span class="string">"versionName"</span>, versionName);</div><div class="line">                infos.put(<span class="string">"versionCode"</span>, versionCode);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</div><div class="line">            LogUtils.e(<span class="string">"CrashHandleran.NameNotFoundException---&gt; error occured when collect package info"</span>, e);</div><div class="line">        &#125;</div><div class="line">        Field[] fields = Build.class.getDeclaredFields();</div><div class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                field.setAccessible(<span class="keyword">true</span>);</div><div class="line">                infos.put(field.getName(), field.get(<span class="keyword">null</span>).toString());</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                LogUtils.e(<span class="string">"CrashHandler.NameNotFoundException---&gt; an error occured when collect crash info"</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 保存错误信息到文件中</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> ex</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 返回文件名称, 便于将文件传送到服务器</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">saveCrashInfo2File</span><span class="params">(Throwable ex)</span> </span>&#123;</div><div class="line"></div><div class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</div><div class="line">        sb.append(<span class="string">"---------------------sta--------------------------"</span>);</div><div class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : infos.entrySet()) &#123;</div><div class="line">            String key = entry.getKey();</div><div class="line">            String value = entry.getValue();</div><div class="line">            sb.append(key + <span class="string">"="</span> + value + <span class="string">"\n"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Writer writer = <span class="keyword">new</span> StringWriter();</div><div class="line">        PrintWriter printWriter = <span class="keyword">new</span> PrintWriter(writer);</div><div class="line">        ex.printStackTrace(printWriter);</div><div class="line">        Throwable cause = ex.getCause();</div><div class="line">        <span class="keyword">while</span> (cause != <span class="keyword">null</span>) &#123;</div><div class="line">            cause.printStackTrace(printWriter);</div><div class="line">            cause = cause.getCause();</div><div class="line">        &#125;</div><div class="line">        printWriter.close();</div><div class="line">        String result = writer.toString();</div><div class="line">        sb.append(result);</div><div class="line">        sb.append(<span class="string">"--------------------end---------------------------"</span>);</div><div class="line">        LogUtils.e(sb.toString());</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">然后我们在Application中，对CrashHandler进行初始化。</div><div class="line"><span class="keyword">import</span> android.app.Application;</div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.yuyh.utils.CrashHandler;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created by yuyuhang on 15/12/7.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Context mContext;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        CrashHandler crashHandler = CrashHandler.getInstance();</div><div class="line">        crashHandler.init(getApplicationContext());</div><div class="line">        mContext = <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样的话，当程序代码中并未捕获异常，但发生了异常的时候，就会交由<code>CrashHandler</code>进行处理，异常信息可以保存到日志文件中。日志文件记录请参考：<a href="http://blog.csdn.net/yyh352091626/article/details/49562411" target="_blank" rel="external">Android 日志打印工具类 可显示打印所在的方法和行号</a>,<br>这样子，就能把异常信息及其异常发生所在的位置，保存在日志文件中。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/25/android-memory-leak-optimization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LeBron_Six">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/15133565?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LeBron_Six 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/25/android-memory-leak-optimization/" itemprop="url">浅谈Android开发中内存泄露与优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-01-25T21:13:04+08:00">
                2016-01-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>内存泄露是在Android开发中尤其要重视的一个问题，对开发人员开说，这是一个很容易犯也很常见的错误。优化内存泄露的问题，主要从两方面着手，一是开发人员避免写出有内存泄露的代码，二是通过一些诸如MAT的内存分析工具来找出潜在的内存泄露并解决它。<br>其实平时遇到的最多的情况，就是对 <figure class="highlight plain"><figcaption><span>或 ```Context``` 保持一个长生命周期的引用。下面主要来分析一下造成内存泄露的各种原因。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## 一、静态变量导致的内存泄露</div><div class="line"></div><div class="line">要不怎么说static关键字要慎用呢？来看看下面这段代码，Context对象为静态的，那么Activity就无法正常销毁，会常驻内存。</div><div class="line"></div><div class="line">```java</div><div class="line">public class MemoryActivity extends Activity&#123;</div><div class="line">    public static Context mContext;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        mContext = this;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这是一个很隐晦的内存泄漏的情况，在开发过程中，<figure class="highlight plain"><figcaption><span>能使用 ```ApplicationContext``` 得尽量使用 ```ApplicationContext``` ，因为这个 ```Context``` 的生存周期和你的应用的生存周期一样长，而不是取决于activity的生存周期。除此之外，在 ```Activity``` 里面创建了静态的View，这就意味着该View持有一个对当前这个 ```Activity``` 的引用，那么 ```Activity``` 也是无法正常销毁的。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## 二、引用没释放导致的内存泄露</div><div class="line"></div><div class="line">### 1、注册服务没取消导致的内存泄露</div><div class="line"></div><div class="line">假如我们在锁屏界面(LockScreen)中，监听系统中的电话服务以获取一些信息(如信号强度等)，则可以在```LockScreen``` 中定义一个 ```PhoneStateListener``` 的对象，同时将它注册到 ```TelephonyManager``` 服务中。对于LockScreen对象，当需要显示锁屏界面的时候就会创建一个LockScreen对象，而当锁屏界面消失的时候LockScreen对象就会被释放掉。但是如果在释放LockScreen对象的时候没有取消之前注册的PhoneStateListener对象，那么则会导致LockScreen无法被垃圾回收。而锁屏界面又不断的创建和销毁，则最终会由于大量的LockScreen对象没有办法被回收而引起 ```OutOfMemory``` 。类似的，```BraodcastReceiver```，```ContentObserver```，```FileObserver``` 在 Activity onDeatory或者某类声明周期结束之后一定要unregister掉，否则这个Activity类会被system强引用，不会被内存回收。</div><div class="line"></div><div class="line">### 2、集合中的对象没有及时清理导致的内存泄露</div><div class="line"></div><div class="line">当该集合为静态的时候，那么在集合里面对象越来越多的时候，最好要及时清理不需要用到的对象。</div><div class="line"></div><div class="line">## 三、单例模式导致的内存泄露</div><div class="line">单例模式的特点就是它的生命周期和 ```Application``` 一样，那么如果某个 ```Activity``` 实例被一个单例所持有，也就是说在单例里面引用了它，那么就会造成 ```Activity``` 对象无法正常回收释放。</div><div class="line"></div><div class="line">## 四、资源对象未关闭导致的内存泄露</div><div class="line">资源性对象(如 ```Cursor```，```File``` 文件等)往往都用了一些缓冲，我们在不使用的时候，应该及时关闭它们，以便它们的缓冲及时回收内存。它们的缓冲不仅存在于java虚拟机内，还存在于java虚拟机外。如果我们仅仅是把它的引用设置为null，而不关闭它们，往往会造成内存泄露。例如程序中经常会进行查询数据库的操作，但是经常会有使用完毕Cursor后没有关闭的情况。如果我们的查询结果集比较小，对内存的消耗不容易被发现，只有在常时间大量操作的情况下才会复现内存问题，这样就会给以后的测试和问题排查带来困难和风险。类似的，Bitmap在不需要之后，应该调用recycle回收，再置为null。</div><div class="line"></div><div class="line">## 五、属性动画导致的内存泄露</div><div class="line">例如下面的代码，由于该属性动画为循环动画，如果在 ```Activity``` 销毁时，没有取消动画，那么虽然我们看不见动画在执行，实际上动画仍然一直播放下去，这个时候```Button```会被动画所持有，而 ```Button``` 又持有对应的 ```Activity``` 对象，那么就会造成 ```Activity``` 无法正常释放。</div><div class="line"></div><div class="line">```java</div><div class="line">public class MemoryActivity extends Activity&#123;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        Button button = (Button) findViewById(R.id.btn_end);</div><div class="line">        ObjectAnimator animator = ObjectAnimator.ofFloat(button, &quot;&quot;, 0,180);</div><div class="line">        animator.setDuration(2000);</div><div class="line">        animator.setRepeatCount(-1);</div><div class="line">        animator.start(); // 没有调用cancle()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="六、Adapter未使用缓存的convertView导致的内存泄露"><a href="#六、Adapter未使用缓存的convertView导致的内存泄露" class="headerlink" title="六、Adapter未使用缓存的convertView导致的内存泄露"></a>六、Adapter未使用缓存的convertView导致的内存泄露</h2><figure class="highlight plain"><figcaption><span>convertView就是被缓存起来的list item的view对象(初始化时缓存中没有view对象则convertView是null)。由此可以看出，如果我们不去使用 convertView，而是每次都在```getView()```中重新实例化一个View对象的话，即浪费资源也浪费时间，也会使得内存占用越来越大。正确的写法如下</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">```java</div><div class="line">public View getView(int position, ViewconvertView, ViewGroup parent) &#123;</div><div class="line">        View view = null;</div><div class="line">        if (convertView != null) &#123; // 不应该直接new</div><div class="line">                view = convertView; </div><div class="line">                ... </div><div class="line">        &#125; else &#123; </div><div class="line">                view = new Xxx(...);</div><div class="line">                ... </div><div class="line">        &#125; </div><div class="line">        return view; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="七、Handler内部类内存泄露"><a href="#七、Handler内部类内存泄露" class="headerlink" title="七、Handler内部类内存泄露"></a>七、Handler内部类内存泄露</h2><p>当使用内部类（包括匿名类）来创建 <code>Handler</code> 的时候，<code>Handler</code> 对象会隐式地持有一个外部类对象（通常是一个 <code>Activity</code> ）的引用，而Handler通常会伴随着一个耗时的后台线程（例如从网络拉取图片）一起出现，这个后台线程在任务执行完毕（例如图片下载完毕）之后，通过消息机制通知Handler，然后 <code>Handler</code> 把图片更新到界面。然而，如果用户在网络请求过程中关闭了Activity，正常情况下，Activity不再被使用，它就有可能在GC检查时被回收掉，但由于这时线程尚未执行完，而该线程持有<code>Handler</code>的引用，这个Handler又持有<code>Activity</code>的引用，就导致该<code>Activity</code>无法被回收（即内存泄露），直到网络请求结束（例如图片下载完毕）。另外，如果你执行了<code>Handler</code>的<code>postDelayed()</code>方法，该方法会将你的<code>Handler</code>装入一个<code>Message</code>，并把这条<code>Message</code>推到<code>MessageQueue</code>中，那么在你设定的delay到达之前，会有一条<code>MessageQueue</code> -&gt; <code>Message</code> -&gt; <code>Handler</code> -&gt; <code>Activity</code>的链，导致你的Activity被持有引用而无法被回收。可以在<code>Activity</code>结束后，关闭线程，如果你的<code>Handler</code>是被delay的<code>Message</code>持有了引用，那么调用<code>removeCallbacks</code>方法来移除消息队列。</p>
<p>内存泄露检测工具MAT的使用请参考：<a href="http://jingyan.baidu.com/article/ae97a646b4eea8bbfc461d5a.html" target="_blank" rel="external">http://jingyan.baidu.com/article/ae97a646b4eea8bbfc461d5a.html</a>，<br>这里需要强调一点，有一些内存泄露通过Mat是查不出来的，比如native的代码，MAT对C/C++是无能为力的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="https://avatars3.githubusercontent.com/u/15133565?v=4&s=460"
              alt="LeBron_Six" />
          
            <p class="site-author-name" itemprop="name">LeBron_Six</p>
            <p class="site-description motion-element" itemprop="description">Android Developer.</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives">
            
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/smuyyh" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:smuyyh@gmail.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      E-Mail
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LeBron_Six</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  







  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/three/three.min.js"></script>

  
  <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
